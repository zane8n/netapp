#!/bin/bash
#
# NetSnmp - Network Device Discovery Tool
# Version 2.0.0 (Refactored)
# Main entry point for the application.

set -o errexit
set -o nounset
set -o pipefail

# --- Library Sourcing ---
# The LIB_DIR is set by the installer.
readonly LIB_DIR="/usr/local/lib/netsnmp"

# Source all library files. Order matters for dependencies.
source "${LIB_DIR}/core.sh"
source "${LIB_DIR}/ui.sh"
source "${LIB_DIR}/cache.sh"
source "${LIB_DIR}/scan.sh"
source "${LIB_DIR}/discovery.sh"

# --- Main Execution Logic ---
main() {
    # Initialize configuration (sets paths, loads .conf file).
    # Prompts for wizard automatically if config is missing.
    core::init_config

    # Argument parsing
    local action="search"
    local pattern=""
    local custom_networks=""
    local custom_communities=""

    [[ $# -eq 0 ]] && action="search" && pattern="" # Default action: list all

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)              ui::show_help; exit 0 ;;
            -u|--update)            action="update" ;;
            -i|--info)              action="info" ;;
            -c|--clear)             action="clear" ;;
            --discover-aps)         action="discover_aps" ;;
            --wizard)               action="wizard" ;;
            -v|--verbose)           core::set_log_level "VERBOSE" ;;
            -vv|--debug)            core::set_log_level "DEBUG" ;;
            -s|--scan)              action="scan_single"; pattern="${2-}"; shift ;;
            -S|--networks)          custom_networks="${2-}"; shift ;;
            -C|--communities)       custom_communities="${2-}"; shift ;;
            -*)                     core::log "ERROR" "Unknown option: $1"; exit 1 ;;
            *)                      pattern="$1" ;;
        esac
        shift
    done
    
    # Execute the determined action
    case "$action" in
        update)         cache::update "$custom_networks" "$custom_communities" ;;
        info)           ui::show_info ;;
        clear)          cache::clear ;;
        discover_aps)   discovery::update_ap_cache ;;
        scan_single)
            [[ -z "$pattern" ]] && core::log "ERROR" "No IP specified for --scan." && exit 1
            scan::single_host "$pattern"
            ;;
        wizard)         ui::run_config_wizard ;;
        search)         cache::search "$pattern" ;;
        *)              core::log "ERROR" "Internal error: Unhandled action '$action'."; exit 1 ;;
    esac
}

# --- Entry Point ---
main "$@"