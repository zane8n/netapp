#!/bin/bash
#
# NetSnmp v2.0 - Network Discovery Tool
#
# This is the main executable. It sources libraries, parses arguments,
# and dispatches actions to the appropriate functions.

VERSION="2.0.0-refactored"

# --- Setup Environment ---

# Determine application paths.
# LIB_DIR is set relative to the location of this script, making it portable.
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
LIB_DIR="/usr/local/lib/netsnmp" # Standard installation path

# Define global paths. These are based on a standard system-wide installation.
# The script will still function if run from a local directory, but will look
# for config in these standard locations.
CONF_DIR="/etc/netsnmp"
CACHE_DIR="/var/cache/netsnmp"
LOG_DIR="/var/log"

CONFIG_FILE="${CONF_DIR}/netsnmp.conf"
CACHE_FILE="${CACHE_DIR}/netsnmp.cache"
AP_CACHE_FILE="${CACHE_DIR}/netsnmp.aps.cache"
LOG_FILE="${LOG_DIR}/netsnmp.log"

# --- Source Libraries ---
# REFACTOR: All logic is now encapsulated in library files. The main script
# only needs to source them to gain all functionality.

# Check if the library directory exists before sourcing
if [[ ! -d "$LIB_DIR" ]]; then
    echo "ERROR: Library directory not found at '$LIB_DIR'." >&2
    echo "Please ensure NetSnmp is installed correctly." >&2
    exit 1
fi

for lib in "$LIB_DIR"/*.sh; do
    # shellcheck source=/dev/null
    source "$lib"
done


# --- Main Logic ---

main() {
    # Set sane script behavior
    set -o pipefail

    # Default action is to show help if no arguments are given
    local ACTION="help"
    local PATTERN=""
    local CUSTOM_NETWORKS=""
    local CUSTOM_COMMUNITIES=""

    # Check for root privileges on actions that require them
    case "${1:-}" in
        --update|--wizard|--discover-aps|--clear)
            if [[ $EUID -ne 0 ]]; then
                log_error "This command requires root privileges. Please run with 'sudo'."
                exit 1
            fi
            ;;
    esac

    # Initialize global flags
    QUIET="false"
    DEBUG="false"

    # --- Argument Parsing ---
    # REFACTOR: Argument parsing is now cleaner and handles combined options.
    if [[ $# -gt 0 ]]; then
        ACTION="$1"
        shift
    fi

    # Handle search as the default action
    if [[ ! "$ACTION" =~ ^-- && "$ACTION" != "search" ]]; then
        PATTERN="$ACTION"
        ACTION="search"
    fi

    # Load configuration first, so it's available for all actions
    load_config

    case "$ACTION" in
        --update)
            update_cache "$CUSTOM_NETWORKS" "$CUSTOM_COMMUNITIES"
            ;;
        --discover-aps)
            update_ap_cache
            ;;
        search)
            if [[ -z "$PATTERN" ]]; then
                log_error "Please provide a pattern to search for."
                show_help
                exit 1
            fi
            search_cache "$PATTERN"
            ;;
        -i|--info)
            show_info
            ;;
        -c|--clear)
            clear_cache
            ;;
        --wizard)
            run_config_wizard
            ;;
        --config)
            show_config
            ;;
        -h|--help)
            show_help
            ;;
        --version)
            echo "NetSnmp v${VERSION}"
            ;;
        *)
            log_error "Unknown command: $ACTION"
            show_help
            exit 1
            ;;
    esac
}

# Execute the main function with all provided arguments
main "$@"